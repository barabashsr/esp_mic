<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ESP32 Audio Recorder</title>
<style>
* { box-sizing: border-box; margin: 0; padding: 0; }
body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; background: #1a1a2e; color: #eee; padding: 20px; max-width: 600px; margin: 0 auto; }
h1 { font-size: 1.3em; margin-bottom: 16px; color: #e94560; }
.card { background: #16213e; border-radius: 8px; padding: 16px; margin-bottom: 12px; }
.card h2 { font-size: 1em; margin-bottom: 10px; color: #0f3460; color: #a8d8ea; }
button { background: #e94560; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 0.9em; margin: 4px; }
button:hover { opacity: 0.85; }
button:disabled { opacity: 0.4; cursor: not-allowed; }
button.secondary { background: #0f3460; }
button.danger { background: #c0392b; }
button.active { background: #27ae60; }
.status { font-size: 0.85em; color: #888; margin-top: 6px; }
#meter { width: 100%; height: 20px; background: #0a0a1a; border-radius: 4px; overflow: hidden; margin: 8px 0; }
#meter-bar { height: 100%; width: 0%; background: linear-gradient(90deg, #27ae60, #f39c12, #e74c3c); transition: width 50ms; }
#files { list-style: none; }
#files li { display: flex; align-items: center; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid #0a0a1a; font-size: 0.9em; flex-wrap: wrap; }
#files li:last-child { border: none; }
.file-name { flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.file-info { color: #888; margin: 0 8px; font-size: 0.8em; white-space: nowrap; }
.ws-status { display: inline-block; width: 8px; height: 8px; border-radius: 50%; margin-right: 6px; }
.ws-status.connected { background: #27ae60; }
.ws-status.disconnected { background: #c0392b; }
.rms-container { position: relative; width: 100%; height: 20px; background: #0a0a1a; border-radius: 4px; overflow: hidden; margin: 8px 0; }
.rms-bar { height: 100%; width: 0%; background: #27ae60; transition: width 0.3s; }
.rms-threshold { position: absolute; top: 0; height: 100%; width: 2px; background: #e94560; }
.slider-row { display: flex; align-items: center; gap: 10px; margin: 8px 0; }
.slider-row input[type=range] { flex: 1; }
.slider-row span { font-size: 0.85em; min-width: 40px; }
</style>
</head>
<body>
<h1><span class="ws-status disconnected" id="ws-dot"></span>ESP32 Audio Recorder</h1>

<div class="card">
  <h2>Live Audio</h2>
  <div id="meter"><div id="meter-bar"></div></div>
  <button id="btn-listen" onclick="toggleListen()">Start Listening</button>
  <div class="status" id="audio-status">Click to start</div>
</div>

<div class="card">
  <h2>Recording</h2>
  <button id="btn-rec" onclick="toggleRec()">Start Recording</button>
  <div class="status" id="rec-status">Idle</div>
</div>

<div class="card">
  <h2>Settings</h2>
  <label style="display:flex;align-items:center;gap:8px;cursor:pointer">
    <input type="checkbox" id="chk-ulaw" onchange="toggleUlaw(this.checked)">
    <span>µ-law compression (2:1, smaller files)</span>
  </label>
  <hr style="border-color:#0a0a1a;margin:10px 0">
  <label style="display:flex;align-items:center;gap:8px;cursor:pointer">
    <input type="checkbox" id="chk-filter" onchange="toggleFilter(this.checked)">
    <span>Enable audio filter</span>
  </label>
  <div id="filter-controls" style="display:none;margin-top:8px">
    <div class="slider-row">
      <span>Cut low:</span>
      <input type="range" id="filter-hp" min="50" max="2000" step="10" value="200" oninput="updateFilter()">
      <span id="filter-hp-val">Off</span>
    </div>
    <div class="slider-row">
      <span>Cut high:</span>
      <input type="range" id="filter-lp" min="2000" max="9500" step="100" value="6000" oninput="updateFilter()">
      <span id="filter-lp-val">Off</span>
    </div>
  </div>
</div>

<div class="card">
  <h2>Auto-Record</h2>
  <button id="btn-auto" onclick="toggleAuto()">Enable Auto-Record</button>
  <div class="slider-row">
    <span>Threshold:</span>
    <input type="range" id="auto-threshold" min="100" max="10000" step="100" value="2000" oninput="updateThreshold(this.value)">
    <span id="threshold-val">2000</span>
  </div>
  <div class="rms-container">
    <div class="rms-bar" id="rms-bar"></div>
    <div class="rms-threshold" id="rms-threshold" style="left:20%"></div>
  </div>
  <div class="status" id="auto-status">Disabled</div>
  <div class="status" id="zcr-status"></div>
</div>

<div class="card">
  <h2>Files</h2>
  <ul id="files"><li>Loading...</li></ul>
  <button class="secondary" onclick="loadFiles()">Refresh</button>
  <div class="status" id="sd-status"></div>
</div>

<script>
const SAMPLE_RATE = 20000;
let ws = null;
let audioCtx = null;
let listening = false;
let recording = false;
let autoMode = false;
let nextPlayTime = 0;
let thresholdTimer = null;
let filterTimer = null;

function toggleListen() {
  if (!listening) startListen();
  else stopListen();
}

function startListen() {
  audioCtx = new (window.AudioContext || window.webkitAudioContext)({ sampleRate: SAMPLE_RATE });
  nextPlayTime = 0;
  connectWS();
  listening = true;
  document.getElementById('btn-listen').textContent = 'Stop Listening';
  document.getElementById('audio-status').textContent = 'Connecting...';
}

function stopListen() {
  listening = false;
  if (ws) { ws.close(); ws = null; }
  if (audioCtx) { audioCtx.close(); audioCtx = null; }
  document.getElementById('btn-listen').textContent = 'Start Listening';
  document.getElementById('audio-status').textContent = 'Stopped';
  document.getElementById('meter-bar').style.width = '0%';
  document.getElementById('ws-dot').className = 'ws-status disconnected';
}

function connectWS() {
  ws = new WebSocket('ws://' + location.host + '/ws');
  ws.binaryType = 'arraybuffer';

  ws.onopen = function() {
    document.getElementById('ws-dot').className = 'ws-status connected';
    document.getElementById('audio-status').textContent = 'Listening...';
    document.getElementById('btn-rec').disabled = false;
    loadFiles();
    loadStatus();
  };

  ws.onmessage = function(e) {
    if (e.data instanceof ArrayBuffer) {
      playAudio(e.data);
    }
  };

  ws.onclose = function() {
    document.getElementById('ws-dot').className = 'ws-status disconnected';
    if (listening) {
      document.getElementById('audio-status').textContent = 'Reconnecting...';
      setTimeout(connectWS, 2000);
    }
  };
}

function playAudio(buf) {
  if (!audioCtx) return;
  const int16 = new Int16Array(buf);
  const float32 = new Float32Array(int16.length);

  let sumSq = 0;
  for (let i = 0; i < int16.length; i++) {
    float32[i] = int16[i] / 32768;
    sumSq += float32[i] * float32[i];
  }
  const rms = Math.sqrt(sumSq / int16.length);
  const pct = Math.min(100, rms * 300);
  document.getElementById('meter-bar').style.width = pct + '%';

  const audioBuffer = audioCtx.createBuffer(1, float32.length, SAMPLE_RATE);
  audioBuffer.getChannelData(0).set(float32);

  const source = audioCtx.createBufferSource();
  source.buffer = audioBuffer;
  source.connect(audioCtx.destination);

  const now = audioCtx.currentTime;
  if (nextPlayTime < now) nextPlayTime = now;
  source.start(nextPlayTime);
  nextPlayTime += audioBuffer.duration;
}

function toggleRec() {
  const action = recording ? 'stop' : 'start';
  fetch('/api/rec/' + action, { method: 'POST' }).then(() => {
    setTimeout(loadStatus, 500);
  });
}

function toggleAuto() {
  const newMode = !autoMode;
  fetch('/api/auto', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ enabled: newMode })
  }).then(() => {
    setTimeout(loadStatus, 300);
  });
}

function toggleUlaw(checked) {
  fetch('/api/codec', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ ulaw: checked })
  });
}

function toggleFilter(enabled) {
  document.getElementById('filter-controls').style.display = enabled ? 'block' : 'none';
  if (enabled) {
    updateFilter();
  } else {
    sendFilter(0, 0);
  }
}

function updateFilter() {
  const hp = parseInt(document.getElementById('filter-hp').value);
  const lp = parseInt(document.getElementById('filter-lp').value);
  document.getElementById('filter-hp-val').textContent = hp + ' Hz';
  document.getElementById('filter-lp-val').textContent = lp + ' Hz';
  if (filterTimer) clearTimeout(filterTimer);
  filterTimer = setTimeout(() => sendFilter(hp, lp), 300);
}

function sendFilter(hp, lp) {
  fetch('/api/filter', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ hp: hp, lp: lp })
  });
}

function updateThreshold(val) {
  document.getElementById('threshold-val').textContent = val;
  updateThresholdMarker(val);
  // Debounce the API call
  if (thresholdTimer) clearTimeout(thresholdTimer);
  thresholdTimer = setTimeout(() => {
    fetch('/api/auto', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ threshold: parseInt(val) })
    });
  }, 300);
}

function updateThresholdMarker(thr) {
  const pct = Math.min(100, (thr / 10000) * 100);
  document.getElementById('rms-threshold').style.left = pct + '%';
}

function loadFiles() {
  fetch('/api/files').then(r => r.json()).then(files => {
    const ul = document.getElementById('files');
    if (files.length === 0) {
      ul.innerHTML = '<li>No recordings yet</li>';
      return;
    }
    ul.innerHTML = '';
    files.forEach(f => {
      const li = document.createElement('li');
      const sizeMB = (f.size / 1024 / 1024).toFixed(2);
      let info = sizeMB + ' MB';
      if (f.modified) info += ' | ' + f.modified;
      li.innerHTML =
        '<span class="file-name">' + f.name + '</span>' +
        '<span class="file-info">' + info + '</span>' +
        '<button class="secondary" onclick="playFile(\'' + f.name + '\')">Play</button>' +
        '<button class="secondary" onclick="dlFile(\'' + f.name + '\')">DL</button>' +
        '<button class="danger" onclick="delFile(\'' + f.name + '\')">Del</button>';
      ul.appendChild(li);
    });
  }).catch(() => {
    document.getElementById('files').innerHTML = '<li>Error loading files</li>';
  });
}

function loadStatus() {
  fetch('/api/status').then(r => r.json()).then(s => {
    let txt = '';
    if (s.sd_free_mb !== undefined) txt += 'SD free: ' + s.sd_free_mb.toFixed(1) + ' MB';
    if (s.rssi !== undefined) txt += ' | RSSI: ' + s.rssi + ' dBm';
    document.getElementById('sd-status').textContent = txt;

    // Update recording state
    if (s.recording !== undefined) {
      const wasRecording = recording;
      recording = s.recording;
      document.getElementById('btn-rec').textContent = recording ? 'Stop Recording' : 'Start Recording';
      if (recording) {
        let src = s.rec_source === 'auto' ? 'auto' : 'manual';
        let recTxt = 'Recording (' + src + '): ' + (s.filename || '');
        if (s.rec_started_at) recTxt += ' | started ' + s.rec_started_at;
        document.getElementById('rec-status').textContent = recTxt;
      } else {
        document.getElementById('rec-status').textContent = 'Idle';
      }
      if (wasRecording && !recording) loadFiles();
    }

    // Update auto-record state
    if (s.auto_mode !== undefined) {
      autoMode = s.auto_mode;
      const btn = document.getElementById('btn-auto');
      btn.textContent = autoMode ? 'Disable Auto-Record' : 'Enable Auto-Record';
      btn.className = autoMode ? 'active' : '';

      let autoTxt;
      if (!autoMode) {
        autoTxt = 'Disabled';
      } else if (s.recording && s.rec_source === 'auto') {
        autoTxt = 'Auto-recording...';
      } else {
        autoTxt = 'Monitoring...';
      }
      document.getElementById('auto-status').textContent = autoTxt;
    }

    if (s.auto_threshold !== undefined) {
      document.getElementById('auto-threshold').value = s.auto_threshold;
      document.getElementById('threshold-val').textContent = s.auto_threshold;
      updateThresholdMarker(s.auto_threshold);
    }

    // Update RMS bar
    if (s.current_rms !== undefined) {
      const rmsPct = Math.min(100, (s.current_rms / 10000) * 100);
      document.getElementById('rms-bar').style.width = rmsPct + '%';
    }

    // Update µ-law checkbox
    if (s.ulaw !== undefined) {
      document.getElementById('chk-ulaw').checked = s.ulaw;
    }

    // Update ZCR display
    if (s.current_zcr !== undefined) {
      document.getElementById('zcr-status').textContent = 'ZCR: ' + s.current_zcr.toFixed(2);
    }

    // Update filter state
    if (s.filter_hp !== undefined || s.filter_lp !== undefined) {
      const hp = s.filter_hp || 0;
      const lp = s.filter_lp || 0;
      const active = hp > 0 || lp > 0;
      document.getElementById('chk-filter').checked = active;
      document.getElementById('filter-controls').style.display = active ? 'block' : 'none';
      if (hp > 0) {
        document.getElementById('filter-hp').value = hp;
        document.getElementById('filter-hp-val').textContent = hp + ' Hz';
      } else {
        document.getElementById('filter-hp-val').textContent = 'Off';
      }
      if (lp > 0) {
        document.getElementById('filter-lp').value = lp;
        document.getElementById('filter-lp-val').textContent = lp + ' Hz';
      } else {
        document.getElementById('filter-lp-val').textContent = 'Off';
      }
    }
  }).catch(() => {});
}

function playFile(name) {
  const a = new Audio('/api/files/' + name);
  a.play();
}

function dlFile(name) {
  const a = document.createElement('a');
  a.href = '/api/files/' + name;
  a.download = name;
  a.click();
}

function delFile(name) {
  if (!confirm('Delete ' + name + '?')) return;
  fetch('/api/files/' + name, { method: 'DELETE' }).then(() => loadFiles());
}

// Load on page open
loadFiles();
loadStatus();

// Auto-refresh status every 3s
setInterval(loadStatus, 3000);
</script>
</body>
</html>
